<style>
    .page-add-customer {  width: 650px;  margin-top: -10px  }
    .page-add-customer ul {  padding: 0;  margin: 0  }
    .page-add-customer .row {  display: block;  clear: both;  margin: 5px 0  }
    .page-add-customer .service-btn-box {  margin-top: 30px;  padding: 20px;  border-top: solid #ddd 1px  }
    .img { font-size: 30px;width: 60px;height: 70px;height: auto !important;min-height: 70px;overflow: hidden;
        line-height: 70px;text-align: center;padding: 2px;border: 1px solid #ccc  }
    .img img {margin: auto;width: 100%  }
    .col-2 label, .col-2 input, .col-2 select {display: inline;font-weight: normal}
    .col-2 label {display: block;float: left;width: 100px; line-height: 30px;font-weight: 700  }
    .col-2 input, .col-2 select { width: 165px;  }
    .col-2 input[type='radio'] {width: 30px;line-height: 30px;  }
    .agreement-content {width: 650px;max-height: 400px;overflow-y: auto;overflow-x: hidden;  }
    .customer-info {width: 82%;float: left;min-height: 40px;height: auto !important;height: 40px;
        overflow: hidden;border: 1px solid #ddd;margin-bottom: 5px;}
    .tab-content .row div{line-height: 30px;padding: 0 3px 0 0}
    .tab-content .row .col-xs-2{text-align: right;}
    .tab-content .row input[type='text']{padding:3px 3px 3px 5px}
</style>
<div class="page-add-customer">
    <ul class="nav nav-tabs" style="margin-bottom: 15px;">
        <li class="active"><a href="#tab_agreement_add" data-toggle="tab">协议信息</a></li>
        <li><a href="#tab_base_info" data-toggle="tab" class="open_nav_tabs" url="{:U('Customer/tabBaseInfo')}">客户信息</a>
        </li>
        <li><a href="#tab_estate_info" data-toggle="tab" class="open_nav_tabs"
               url="{:U('Customer/tabEstateInfo')}">房产信息</a></li>
        <li><a href="#tab_docs" data-toggle="tab" class="open_nav_tabs" url="{:U('Customer/tabDocs')}">附件列表</a></li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="tab_agreement_add">
            <form id="agreement_create_form" class="form" action="{:U('add')}" method="post">
                <div class="agreement-content">
                    <div class="row">
                        <div class="col-xs-2">客户：</div>
                        <div class="col-xs-4">
                            <div class="input-group">
                                <input type="hidden" class="form-control sel-customer" id="customer_id" name="agreement[customer_id]" value="{$customer[customer_id]}"/>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" value="{$customer[customer_name]}" readonly/>
                                <span class="input-group-btn">
                                    <button class="btn btn-default sel-customer" type="button"><i class="fa fa-search"></i></button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2">协议编号*：</div>
                        <div class="col-xs-4"><input type="text" class="form-control" id="agreement_number"
                                                      name="agreement[number]"  maxlength="11" minlength="1" tag="居间协议编号" value="A"/>
                        </div>
                        <div class="col-xs-2">产品类型：</div>
                        <div class="col-xs-4">
                            <select name="agreement[product_type]" id="product_type" class="form-control">
                                <option value="">选择类型</option>
                                <option value="抵押">抵押</option>
                                <option value="信用">信用</option>
                                <option value="赎楼">赎楼</option>
                            </select>
                        </div>

                    </div>
                    <div class="row">

                        <div class="col-xs-2">借款人*：</div>
                        <div class="col-xs-4"><input type="text" id="borrower" maxlength="20" minlength="1" tag="借款人"
                                                      class="form-control" name="agreement[borrower]"/></div>
                        <div class="col-xs-2">电话*：</div>
                        <div class="col-xs-4"><input type="text" id="telephone" truelength="11" tag="电话"
                                                      class="form-control" name="agreement[telephone]"/></div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2">借款金额*：</div>
                        <div class="col-xs-4">
                            <div class="input-group">
                                <input type="text" id="plan_money" maxlength="10" minlength="1"
                                       tag="拟借款金额" class="form-control" name="agreement[plan_money]"/>
                                <span class="input-group-addon">元</span>
                            </div>
                        </div>
                        <div class="col-xs-2">证件号*：</div>
                        <div class="col-xs-4"><input type="text" id="identity" maxlength="50" minlength="1" tag="证件号"
                                                      class="form-control" name="agreement[identity]"/></div>

                    </div>
                    <div class="row">
                        <div class="col-xs-2">佣金*：</div>
                        <div class="col-xs-4">
                            <div class="input-group">
                                <input type="text" id="commission" maxlength="10" minlength="1" tag="佣金"
                                       class="form-control" name="agreement[commission]"/>
                                <span class="input-group-addon">元</span>
                            </div>
                        </div>
                        <div class="col-xs-2">费率：</div>
                        <div class="col-xs-4">
                            <div class="input-group">
                                <input type="text" id="rate" class="form-control" name="agreement[rate]" />
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>

                    </div>
                    <div class="row">
                        <!--<div class="col-xs-2">收定金：</div>-->
                        <div class="col-xs-4-long" style="display: none;"><input type="checkbox" name="is_deposit"
                                                                                  class="is_deposit" checked="checked"/>
                        </div>
                        <div class="deposit_div">
                            <div class="col-xs-2">预付款：</div>
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <input type="text" class="form-control receivables_pay_money"
                                           maxlength="10" tag="预付款" name="receivables[deposit]"
                                           value="0"/>
                                    <span class="input-group-addon">元</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-xs-2">支付类型：</div>
                        <div class="col-xs-4">
                            <select name="receivables[pay_type]" class="form-control" id="pay_type">
                                <option value=""></option>
                                <option value="1">银行转账</option>
                                <option value="2">现金</option>
                                <option value="3">pos机</option>
                                <option value="4">微信</option>
                                <option value="5">支付宝</option>
                                <option value="6">其他</option>
                            </select>
                        </div>

                        <div class="col-xs-2">支付日期：</div>
                        <div class="col-xs-4">
                            <div class="customer_master_field_value">
                                <input class="form-control" name="receivables[pay_time]" type="text" id="datePicker"
                                       value="{:date('Y-m-d')}">
                            </div>
                        </div>
                    </div>
                    <div class="row" id="pay_person_div" style="display: none;">
                        <div class="col-xs-2">付款人：</div>
                        <div class="col-xs-4"><input type="text" maxlength="20" tag="付款人"
                                                      class="form-control receivables_pay_money"
                                                      name="receivables[payee]" value=""/></div>
                        <div class="col-xs-2">付款账户：</div>
                        <div class="col-xs-4"><input type="text" maxlength="50" tag="付款账户"
                                                      class="form-control receivables_pay_money"
                                                      name="receivables[payee_account]" value=""/></div>
                    </div>
                    <div class="row">
                        <input type="submit" class="btn btn-primary pull-right" name="submit" value="保存">
                    </div>
                </div>
            </form>
        </div>


        <div class="tab-pane" id="tab_base_info"></div>
        <div class="tab-pane" id="tab_estate_info"></div>
        <div class="tab-pane" id="tab_docs"></div>
    </div>
</div>
<script type="text/javascript">
    datePicker('#datePicker', true);
    $("#pay_type").bind("change",function(){
        if($(this).val()==1){
            $('#pay_person_div').show();
        }else{
            $('#pay_person_div').hide();
        }
    });
    $('#agreement_create_form').ajaxForm({success: success, beforeSend: checkForm});
    function success(data) {
        if (data.errNum == 0) {
            showSuccess(data.retData);
            closeDlg();
        } else {
            showError(data.errMsg);
        }
    }
    function checkForm() {

        if (checkInputLength('#agreement_create_form') === false) {
            return false;
        }

        if ($.trim($('#customer_id').val()) == '') {
            showWarning('没有选择客户！');
            return false;
        }
        if ($('#product_type').val() === '') {
            showWarning('请选择产品类型！');
            return false;
        }

    }
    $(".is_deposit").click(function () {
        if ($("input[class='is_deposit']").is(':checked')) {
            $('.deposit_div').show();
        } else {
            $('.deposit_div').hide();
            $("input[name='deposit']").val('');
        }
    });

    $(".sel-customer").click(function () {
        openAjaxDialog('选择客户', '{:U("Customer/selCustomer")}/', true, 'nav');
    });

    var plan = 0;
    var commission = 0;
    $('#plan_money').keyup(function () {
        var val = parseFloat($.trim($(this).val()));
        if (isNaN(val)) {
            showError("请正确填写值");
            $(this).val(0);
        } else {
            plan = val;
            if (plan && commission) {
                $('#rate').val((commission*100 / plan).toFixed(2));
            } else {
                $('#rate').val(0);
                $('#commission').val(0);
            }
        }
    });
    $('#commission').keyup(function () {
        var val = parseFloat($.trim($(this).val()));
        if (isNaN(val)) {
            showError("请正确填写值");
            $(this).val(0);
        } else {
            var commission = val;
            if (plan) {
                $('#rate').val((commission*100 / plan).toFixed(2));
            } else {
                $('#plan_money').val(0);
                $('#rate').val(0);
            }
        }
    });
    $('#rate').keyup(function () {
        var val = parseFloat($.trim($(this).val()));
        if (isNaN(val)) {
            showError("请正确填写值");
            $(this).val(0);
        } else {
            var rate = val;
            var plan = parseFloat($.trim($('#plan_money').val()));
            if (plan) {
                $('#commission').val((plan * rate/100).toFixed(2));
            } else {
                $('#plan_money').val(0);
                $('#rate').val(0);
            }
        }
    });
    $('.open_nav_tabs').click(function () {
        var customer_id = $('#customer_id').val();
        if (customer_id == "") {
            showError("请先选择客户");
            return false;
        }
        var tab_name = $(this).attr("href");
        var url = $(this).attr("url");
        if ($(tab_name).text() == "") {
            var link = url + "?customer_id=" + customer_id;
            loadURL(link, tab_name);
        }
    });

</script>

